#!/usr/bin/env bash
# #######################################################################
# this script aims to run jar file which is built on spring boot 2.3.12+.
# it supports many modes. see config/services.ini for detail.
#
# author: Leo ning <windywany@gmail.com>
# date: 2023-06-10
# version: 1.0.0
#
### do not edit this file unless you known what you are doing.###########
#########################################################################
set -e

if [ "$1" = "-mode" ]; then
    function change_to_workdir {
        local SOURCE="$1"
        while [ -h "$SOURCE" ]; do
            DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
            SOURCE="$(readlink "$SOURCE")"
            [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
        done
        WORKSPACE="$(cd -P "$(dirname "$SOURCE")/../" && pwd)"
        cd "${WORKSPACE}"
        export WORKSPACE
    }
    change_to_workdir "$0"
    if [ -z "${SERVICE_NAME}" ]; then
        echo "Please specify the service to run"
        exit 142
    elif [[ ! -e "${WORKSPACE}/${SERVICE_NAME}/" ]]; then
        echo "Service not found: ${SERVICE_NAME}"
        exit 142
    fi

    cd "${WORKSPACE}/${SERVICE_NAME}/"
    shift

    if [ -f "${WORKSPACE}/bin/env.sh" ]; then
        source "${WORKSPACE}/bin/env.sh"
    fi

    if [ $# = 0 ]; then
        echo "Please specify run mode: <launcher|fatjar|jar>"
        exit 142
    fi

    RUN_MODE=$1
    shift

    export JAVA_OPTS="${JAVA_OPTS} -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom"
    export JAVA_OPTS="${JAVA_OPTS} $JVM_GC_OPTS $JVM_OOM_OPTS"
    export JAVA_OPTS="${JAVA_OPTS} -Dserver.port=8080 -Dmanagement.server.port=8081"
    # echo "JAVA_OPTS: $JAVA_OPTS"

    if [ "$RUN_MODE" = "launcher" ]; then
        set -- java -ea ${JAVA_OPTS} org.springframework.boot.loader.JarLauncher ${APP_OPTS} "$@"
    elif [ "$RUN_MODE" = "fatjar" ]; then
        set -- java -ea ${JAVA_OPTS} -jar "${SERVICE_NAME}.jar" ${APP_OPTS} "$@"
    elif [ "$RUN_MODE" = "jar" ]; then
        if [ $# = 0 ]; then
            echo "Please specify the lib dir"
            exit 142
        fi
        APP_LIBS=$1
        shift
        set -- java -ea ${JAVA_OPTS} "-Dloader.path=${APP_LIBS}" -jar "${SERVICE_NAME}.jar" ${APP_OPTS} "$@"
    else
        echo "Unknown run mode: $RUN_MODE"
        exit 142
    fi
elif [ $# = 0 ]; then
    set -- echo "${SERVICE_NAME}-${SERVICE_VER}" "$@"
fi

exec "$@"
